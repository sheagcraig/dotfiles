---
- name: Ensure all required directories are present.
  file: 
    path: "{{ item.dir | expanduser }}"
    state: directory
  when: item.limit_to_platform | default(ansible_system) == ansible_system
  with_items: "{{ dotfiles_files }}"
  become: "{{ True if not item.dir.startswith('~') else False }}"

- block:
  - name: Copy all non-git files from Dropbox desired location into place for Mac.
    copy:
      src: "{{ secrets_dir | expanduser }}/{{ item.1.name }}"
      dest: "{{item.0.dir | expanduser }}/{{ item.1.name }}"
      owner: "{{ item.1.owner | default(omit) }}"
      group: "{{ item.1.group| default(omit) }}"
      mode: "{{ item.1.mode | default(omit) }}"
    become: "{{ True if item.1.owner| default('') == 'root' else False }}"
    when: 
      - item.1.type | default('link')  == 'secret'
      - item.1.limit_to_platform | default(ansible_system) == ansible_system
    with_subelements:
      - "{{ dotfiles_files }}"
      - files
  rescue:
    - debug: msg="Secret copy failed; is {{ secrets_dir }} available and synced?"

- name: Link all dotfiles.
  file:
    src: "{{ playbook_dir }}/{{ item.1.name }}"
    dest: "{{ item.0.dir | expanduser }}/{{ item.1.name }}"
    force: True
    owner: "{{ item.1.owner | default(omit) }}"
    group: "{{ item.1.group| default(omit) }}"
    mode: "{{ item.1.mode | default(omit) }}"
    state: link
  become: "{{ True if item.1.owner| default('') == 'root' else False }}"
  when:
    - item.1.type | default('link')  == 'link'
    - item.1.limit_to_platform | default(ansible_system) == ansible_system
  with_subelements:
    - "{{ dotfiles_files }}"
    - files
